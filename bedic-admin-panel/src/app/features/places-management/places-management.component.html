<div class="places-management-container">
  <!-- Header -->
  <div class="header">
    <h1>üìç Gesti√≥n de Lugares - BDIC Map</h1>
    <p class="subtitle">Sistema de gesti√≥n de lugares propios sin dependencias de terceros</p>
    <button mat-raised-button color="primary" (click)="openForm()" [disabled]="loading">
      <mat-icon>add_location</mat-icon>
      Agregar Nuevo Lugar
    </button>
  </div>

  <!-- Estad√≠sticas -->
  <div class="stats-grid">
    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon">üìä</div>
        <div class="stat-value">{{ stats.total }}</div>
        <div class="stat-label">Total de Lugares</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card verified">
      <mat-card-content>
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-value">{{ stats.verified }}</div>
        <div class="stat-label">Verificados</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card pending">
      <mat-card-content>
        <div class="stat-icon">‚è≥</div>
        <div class="stat-value">{{ stats.unverified }}</div>
        <div class="stat-label">Sin Verificar</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card barranquilla">
      <mat-card-content>
        <div class="stat-icon">üèôÔ∏è</div>
        <div class="stat-value">
          {{ (stats.byCity.find(c => c.city === 'Barranquilla')?.count || 0) }}
        </div>
        <div class="stat-label">Barranquilla</div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Filtros -->
  <mat-card class="filters-card">
    <mat-card-content>
      <div class="filters-grid">
        <mat-form-field appearance="outline">
          <mat-label>Buscar</mat-label>
          <input matInput [(ngModel)]="searchQuery" placeholder="Nombre o direcci√≥n...">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Departamento</mat-label>
          <mat-select [(ngModel)]="filterDepartment" (selectionChange)="applyFilters()">
            <mat-option value="">{{ 'common.all' | translate }}</mat-option>
            <mat-option *ngFor="let dept of departments" [value]="dept">
              {{ dept }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Ciudad</mat-label>
          <mat-select [(ngModel)]="filterCity" (selectionChange)="applyFilters()">
            <mat-option value="">{{ 'common.all' | translate }}</mat-option>
            <mat-option value="Barranquilla">Barranquilla</mat-option>
            <mat-option value="Bogot√°">Bogot√°</mat-option>
            <mat-option value="Medell√≠n">Medell√≠n</mat-option>
            <mat-option value="Cali">Cali</mat-option>
            <mat-option value="Cartagena">Cartagena</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Categor√≠a</mat-label>
          <mat-select [(ngModel)]="filterCategory" (selectionChange)="applyFilters()">
            <mat-option value="">{{ 'common.all' | translate }}</mat-option>
            <mat-option *ngFor="let cat of categories" [value]="cat.value">
              {{ cat.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Estado</mat-label>
          <mat-select [(ngModel)]="filterVerified" (selectionChange)="applyFilters()">
            <mat-option [value]="null">{{ 'common.all' | translate }}</mat-option>
            <mat-option [value]="true">{{ 'common.verified' | translate }}</mat-option>
            <mat-option [value]="false">{{ 'common.unverified' | translate }}</mat-option>
          </mat-select>
        </mat-form-field>

        <div class="filter-actions">
          <button mat-raised-button color="primary" (click)="applyFilters()">
            <mat-icon>filter_list</mat-icon>
            Aplicar
          </button>
          <button mat-stroked-button (click)="resetFilters()">
            <mat-icon>clear</mat-icon>
            Limpiar
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Tabla de Lugares -->
  <mat-card class="table-card">
    <mat-card-content>
      <div class="table-container">
        <table mat-table [dataSource]="dataSource" matSort class="places-table">
          <!-- Nombre -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Nombre</th>
            <td mat-cell *matCellDef="let place">
              <div class="place-name">
                <strong>{{ place.name }}</strong>
                <small *ngIf="place.address">{{ place.address }}</small>
              </div>
            </td>
          </ng-container>

          <!-- Categor√≠a -->
          <ng-container matColumnDef="category">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Categor√≠a</th>
            <td mat-cell *matCellDef="let place">
              <span class="category-badge">{{ getCategoryLabel(place.category) }}</span>
            </td>
          </ng-container>

          <!-- Ciudad -->
          <ng-container matColumnDef="city">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Ubicaci√≥n</th>
            <td mat-cell *matCellDef="let place">
              <div class="location-info">
                <div><strong>{{ place.city || 'Sin ciudad' }}</strong></div>
                <small>{{ place.department || 'Sin departamento' }}</small>
                <small *ngIf="place.sector" class="sector">{{ place.sector }}</small>
              </div>
            </td>
          </ng-container>

          <!-- Verificado -->
          <ng-container matColumnDef="verified">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Estado</th>
            <td mat-cell *matCellDef="let place">
              <span class="status-badge" [class.verified]="place.verified" [class.unverified]="!place.verified">
                {{ place.verified ? '‚úÖ Verificado' : '‚è≥ Pendiente' }}
              </span>
            </td>
          </ng-container>

          <!-- Im√°genes -->
          <ng-container matColumnDef="images">
            <th mat-header-cell *matHeaderCellDef>Im√°genes</th>
            <td mat-cell *matCellDef="let place">
              <span class="images-badge">
                <mat-icon>image</mat-icon>
                {{ place.officialImages?.length || 0 }}
              </span>
            </td>
          </ng-container>

          <!-- Acciones -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let place">
              <button mat-icon-button (click)="openForm(place)" matTooltip="Editar">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="deletePlace(place)" matTooltip="Eliminar">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>

        <mat-paginator
          [pageSizeOptions]="[10, 25, 50, 100]"
          showFirstLastButtons
          aria-label="Seleccionar p√°gina">
        </mat-paginator>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Formulario (Modal/Sidebar) -->
  <div class="form-overlay" *ngIf="showForm" (click)="closeForm()"></div>
  <div class="form-sidebar" *ngIf="showForm">
    <div class="form-header">
      <h2>{{ editMode ? '‚úèÔ∏è Editar Lugar' : '‚ûï Nuevo Lugar' }}</h2>
      <button mat-icon-button (click)="closeForm()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="form-content">
      <form [formGroup]="placeForm">
        <!-- Informaci√≥n B√°sica -->
        <h3>üìù Informaci√≥n B√°sica</h3>
        
        <mat-form-field appearance="outline">
          <mat-label>Nombre del Lugar *</mat-label>
          <input matInput formControlName="name" placeholder="Ej: Restaurante La Troja">
          <mat-error *ngIf="placeForm.get('name')?.hasError('required')">
            El nombre es requerido
          </mat-error>
          <mat-error *ngIf="placeForm.get('name')?.hasError('minlength')">
            M√≠nimo 3 caracteres
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Categor√≠a *</mat-label>
          <mat-select formControlName="category">
            <mat-option *ngFor="let cat of categories" [value]="cat.value">
              {{ cat.label }}
            </mat-option>
          </mat-select>
          <mat-error>La categor√≠a es requerida</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Descripci√≥n</mat-label>
          <textarea matInput formControlName="description" rows="3"
            placeholder="Descripci√≥n breve del lugar..."></textarea>
        </mat-form-field>

        <!-- Ubicaci√≥n -->
        <h3>üìç Ubicaci√≥n</h3>

        <mat-form-field appearance="outline">
          <mat-label>Departamento *</mat-label>
          <mat-select formControlName="department">
            <mat-option *ngFor="let dept of departments" [value]="dept">
              {{ dept }}
            </mat-option>
          </mat-select>
          <mat-error>El departamento es requerido</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Ciudad *</mat-label>
          <mat-select formControlName="city">
            <mat-option *ngFor="let city of cities" [value]="city">
              {{ city }}
            </mat-option>
          </mat-select>
          <mat-error>La ciudad es requerida</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Sector/Barrio</mat-label>
          <input matInput formControlName="sector" placeholder="Ej: Norte, Centro, Sur">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Direcci√≥n</mat-label>
          <input matInput formControlName="address" placeholder="Ej: Calle 84 #52-45">
        </mat-form-field>

        <!-- Coordenadas -->
        <h3>üó∫Ô∏è Coordenadas</h3>
        
        <div class="coordinates-grid">
          <mat-form-field appearance="outline">
            <mat-label>Latitud *</mat-label>
            <input matInput type="number" formControlName="latitude" 
              placeholder="10.9685" step="0.000001">
            <mat-error>Latitud inv√°lida (-90 a 90)</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Longitud *</mat-label>
            <input matInput type="number" formControlName="longitude" 
              placeholder="-74.7813" step="0.000001">
            <mat-error>Longitud inv√°lida (-180 a 180)</mat-error>
          </mat-form-field>
        </div>

        <button mat-stroked-button type="button" (click)="openMapPicker()" class="map-picker-btn">
          <mat-icon>map</mat-icon>
          Seleccionar en Mapa
        </button>

        <!-- Im√°genes -->
        <h3>üñºÔ∏è Im√°genes</h3>
        
        <div class="image-upload">
          <input type="file" #fileInput accept="image/*" multiple 
            (change)="onImageSelect($event)" style="display: none;">
          
          <button mat-raised-button type="button" (click)="fileInput.click()">
            <mat-icon>add_photo_alternate</mat-icon>
            Seleccionar Im√°genes
          </button>
          
          <p class="upload-hint">
            M√°ximo 10MB por imagen. Se comprimir√°n autom√°ticamente a WebP (85% calidad)
          </p>
        </div>

        <!-- Preview de im√°genes -->
        <div class="image-previews" *ngIf="imagePreviewUrls.length > 0">
          <div class="image-preview" *ngFor="let url of imagePreviewUrls; let i = index">
            <img [src]="url" alt="Preview">
            <button mat-icon-button class="remove-image" (click)="removeImage(i)">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>

        <!-- Im√°genes existentes (modo edici√≥n) -->
        <div class="existing-images" *ngIf="editMode && selectedPlace?.officialImages?.length">
          <h4>Im√°genes Actuales</h4>
          <div class="image-grid">
            <div class="existing-image" *ngFor="let img of selectedPlace.officialImages">
              <img [src]="'http://localhost:5000' + img" alt="Imagen del lugar">
              <button mat-icon-button class="delete-image" 
                (click)="deleteImage(selectedPlace, img)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>

        <!-- Verificaci√≥n -->
        <div class="verification-section" *ngIf="editMode">
          <mat-checkbox formControlName="verified">
            ‚úÖ Marcar como verificado
          </mat-checkbox>
        </div>
      </form>
    </div>

    <div class="form-actions">
      <button mat-raised-button color="primary" (click)="savePlaceAndUploadImages()" 
        [disabled]="loading || uploadingImages">
        <mat-spinner *ngIf="loading || uploadingImages" diameter="20"></mat-spinner>
        <mat-icon *ngIf="!loading && !uploadingImages">save</mat-icon>
        {{ editMode ? 'Actualizar' : 'Crear' }} Lugar
      </button>
      <button mat-stroked-button (click)="closeForm()" [disabled]="loading || uploadingImages">
        Cancelar
      </button>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="loading">
    <mat-spinner></mat-spinner>
    <p>Cargando...</p>
  </div>
</div>
